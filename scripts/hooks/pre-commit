#!/bin/sh
#
# Pre-commit hook: LIGHTWEIGHT checks only
#
# WHY lightweight: Commits should be fast to enable "save point" commits.
# Tests and heavy validation run at pre-push, not pre-commit.
#
# WHAT THIS DOES:
# 1. Auto-format staged files (prettier)
# 2. Auto-fix lint issues (eslint --fix)
# 3. Re-stage formatted/fixed files
#
# WHAT THIS DOES NOT DO (intentionally):
# - Run tests (too slow, blocks quick commits)
# - Type check (can block emergency commits)
# - Build (not needed for commits)
# - Security scans (run at pre-push)
#
# PRINCIPLE: "Commit early, commit often, push when ready"
#

set -e

# ============================================================================
# Configuration
# ============================================================================

LOCK_FILE="/tmp/svg-bbox-pre-commit.lock"
LOCK_TIMEOUT_SECONDS=60  # Short timeout - lightweight checks should be fast

# ANSI Color Codes
COLOR_RED='\033[0;31m'
COLOR_GREEN='\033[0;32m'
COLOR_YELLOW='\033[1;33m'
COLOR_RESET='\033[0m'

# ============================================================================
# Functions
# ============================================================================

log_phase() {
    echo "${COLOR_YELLOW}â†’${COLOR_RESET} $1..."
}

print_status() {
    if [ $1 -eq 0 ]; then
        echo "${COLOR_GREEN}âœ“${COLOR_RESET} $2"
    else
        echo "${COLOR_RED}âœ—${COLOR_RESET} $2"
        return 1
    fi
}

# ============================================================================
# Main
# ============================================================================

echo "ðŸ” Running pre-commit checks (lightweight)..."
echo ""

# File locking
exec 200>"$LOCK_FILE"
if ! flock -n 200; then
    echo "${COLOR_YELLOW}â³${COLOR_RESET} Waiting for another pre-commit hook..."
    if ! flock -w "$LOCK_TIMEOUT_SECONDS" 200; then
        echo "${COLOR_RED}âœ—${COLOR_RESET} Timeout waiting for lock"
        exit 1
    fi
fi

# Create temp directory
TEMP_DIR=$(mktemp -d)
trap "rm -rf $TEMP_DIR; flock -u 200" EXIT

FAILED=0

# Save staged files BEFORE formatting
STAGED_FILES="$TEMP_DIR/staged-files.txt"
git diff --cached --name-only --diff-filter=ACM > "$STAGED_FILES"

# Skip if no staged files
if [ ! -s "$STAGED_FILES" ]; then
    echo "${COLOR_GREEN}âœ“${COLOR_RESET} No staged files to check"
    exit 0
fi

# ============================================================================
# Step 1: Auto-format and auto-fix (prettier + eslint --fix)
# ============================================================================

log_phase "Auto-formatting and fixing staged files"
LINT_LOG="$TEMP_DIR/lint.log"

# WHY lint:fix: Automatically fixes formatting and simple lint issues
# If it fails, shows errors but doesn't block the commit
if bun run lint:fix > "$LINT_LOG" 2>&1; then
    print_status 0 "Code formatted and lint issues auto-fixed"
else
    # Lint:fix failed - show what couldn't be auto-fixed
    print_status 1 "Some issues couldn't be auto-fixed"
    echo ""
    echo "Unfixable issues:"
    tail -30 "$LINT_LOG"
    FAILED=1
fi

# Re-stage any files that were formatted/fixed
if [ -s "$STAGED_FILES" ]; then
    while IFS= read -r file; do
        if [ -f "$file" ]; then
            git add "$file"
        fi
    done < "$STAGED_FILES"
fi

echo ""

# ============================================================================
# Result
# ============================================================================

if [ $FAILED -eq 0 ]; then
    echo "${COLOR_GREEN}âœ“ Pre-commit checks passed (lightweight)${COLOR_RESET}"
    echo ""
    echo "Note: Full validation (tests, typecheck, build) runs at pre-push."
    exit 0
else
    echo "${COLOR_RED}âœ— Pre-commit checks failed${COLOR_RESET}"
    echo ""
    echo "Fix the issues above, or bypass with: git commit --no-verify"
    exit 1
fi
