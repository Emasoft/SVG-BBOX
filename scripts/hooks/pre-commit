#!/bin/sh
#
# Pre-commit hook to run all CI checks locally before committing
# This ensures we catch issues before pushing to GitHub
#

set -e

# ============================================================================
# Configuration Constants - Single Source of Truth
# ============================================================================

# Log output configuration
LOG_TAIL_LINES=100  # Number of lines to show from failed test output

# File locking configuration
# WHY: If user runs 'git commit' twice simultaneously (different terminals),
# both hooks run concurrently causing race conditions in test execution,
# temp file conflicts, and git lock conflicts.
# WHAT NOT TO DO: Don't rely on git's internal locking - it doesn't prevent
# concurrent hook execution, only concurrent git operations.
LOCK_FILE="/tmp/svg-bbox-pre-commit.lock"
LOCK_TIMEOUT_SECONDS=300  # 5 minutes max wait for lock

# ANSI Color Codes
# Standard terminal color codes for formatting output
COLOR_RED='\033[0;31m'
COLOR_GREEN='\033[0;32m'
COLOR_YELLOW='\033[1;33m'
COLOR_RESET='\033[0m'  # Reset to default terminal color

# ============================================================================
# Logging Functions
# ============================================================================

# Log the start of a check phase
log_phase() {
    echo "${COLOR_YELLOW}â†’${COLOR_RESET} $1..."
}

# Print colored status message based on exit code
print_status() {
    if [ $1 -eq 0 ]; then
        echo "${COLOR_GREEN}âœ“${COLOR_RESET} $2"
    else
        echo "${COLOR_RED}âœ—${COLOR_RESET} $2"
        return 1
    fi
}

# ============================================================================
# Main Pre-Commit Checks
# ============================================================================

echo "ðŸ” Running pre-commit checks..."
echo ""

# ============================================================================
# File Locking - Prevent Concurrent Execution
# ============================================================================
# Acquire exclusive lock to prevent race conditions when multiple commits
# run simultaneously. Uses file descriptor 200 for the lock.
# WHY: Without locking, concurrent executions cause:
# - Conflicting temp directory usage (mktemp creates different dirs)
# - Overlapping test execution (test results get mixed up)
# - Git index lock conflicts
# - Non-deterministic pass/fail results due to resource contention
exec 200>"$LOCK_FILE"
if ! flock -n 200; then
    echo "${COLOR_YELLOW}â³${COLOR_RESET} Another pre-commit hook is already running. Waiting for lock..."
    # Block until lock is available or timeout expires
    if ! flock -w "$LOCK_TIMEOUT_SECONDS" 200; then
        echo "${COLOR_RED}âœ—${COLOR_RESET} Timeout waiting for lock after ${LOCK_TIMEOUT_SECONDS} seconds"
        echo "  This may indicate a stuck pre-commit hook process."
        echo "  Check for hung processes: ps aux | grep pre-commit"
        echo "  Manual lock removal (use with caution): rm \"$LOCK_FILE\""
        exit 1
    fi
    echo "${COLOR_GREEN}âœ“${COLOR_RESET} Lock acquired, proceeding with checks..."
    echo ""
fi

# Create platform-agnostic temporary directory
# mktemp works on Unix, Mac, and Git Bash on Windows
TEMP_DIR=$(mktemp -d)
# Cleanup on exit AND release lock
# WHY: Release lock in trap ensures it's freed even on failures/signals
trap "rm -rf $TEMP_DIR; flock -u 200" EXIT

# Track overall status
FAILED=0

# Save list of staged files BEFORE formatting
# WHY: We need to re-stage these files after lint:fix modifies them
# Without this, formatted changes stay in working dir and don't get committed
STAGED_FILES="$TEMP_DIR/staged-files.txt"
git diff --cached --name-only --diff-filter=ACM > "$STAGED_FILES"

# 1. Run linter with auto-fix (prettier + eslint)
# WHY: Auto-format and auto-fix files before committing to ensure consistency
# ORDER: prettier --write (format) â†’ eslint --fix (fix lint issues)
log_phase "Running linter with auto-fix (prettier + eslint)"
LINT_LOG="$TEMP_DIR/pre-commit-lint.log"
if pnpm run lint:fix > "$LINT_LOG" 2>&1; then
    print_status 0 "Linter passed (files auto-formatted and auto-fixed)"

    # Re-stage any files that were formatted
    # WHY: lint:fix modifies files in working dir, but staged versions are stale
    # CRITICAL: This ensures formatted code gets committed, not the pre-formatted version
    if [ -s "$STAGED_FILES" ]; then
        while IFS= read -r file; do
            if [ -f "$file" ]; then
                git add "$file"
            fi
        done < "$STAGED_FILES"
    fi
else
    print_status 1 "Linter failed"
    echo ""
    echo "Linter output:"
    cat "$LINT_LOG"
    FAILED=1
fi
echo ""

# 2. Run type checker
log_phase "Running type checker"
TYPECHECK_LOG="$TEMP_DIR/pre-commit-typecheck.log"
if pnpm run typecheck > "$TYPECHECK_LOG" 2>&1; then
    print_status 0 "Type checker passed"
else
    print_status 1 "Type checker failed"
    echo ""
    echo "Type checker output:"
    cat "$TYPECHECK_LOG"
    FAILED=1
fi
echo ""

# 3. Run selective tests (based on changed files)
log_phase "Running selective tests (analyzing changed files)"
TESTS_LOG="$TEMP_DIR/pre-commit-tests.log"
# Use the selective test runner to only test what changed
if node scripts/test-selective.cjs HEAD > "$TESTS_LOG" 2>&1; then
    print_status 0 "Tests passed (selective testing based on changes)"
else
    print_status 1 "Tests failed"
    echo ""
    echo "Test output (last ${LOG_TAIL_LINES} lines):"
    tail -${LOG_TAIL_LINES} "$TESTS_LOG"
    FAILED=1
fi
echo ""

# Final result
if [ $FAILED -eq 0 ]; then
    echo "${COLOR_GREEN}âœ“ All pre-commit checks passed!${COLOR_RESET}"
    echo ""
    exit 0
else
    echo "${COLOR_RED}âœ— Some pre-commit checks failed${COLOR_RESET}"
    echo ""
    echo "Please fix the issues above before committing."
    echo "If you need to bypass these checks (not recommended), use:"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi
